name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Build
        run: npm run build
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
      - name: Prepare release directory
        run: |
          npm install
          VERSION=${GITHUB_REF_NAME}
          [ -z "$VERSION" ] && VERSION=dev
          mkdir release
          cp -r dist release/dist
          cp -r server release/server
          cp -r scripts release/scripts
          cp package.json package-lock.json release/
          # lightweight README subset for device deploy (optional)
          cp README.md release/
          echo 'PORT=3000' > release/.env.example
          cat > release/run.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          DIR="$(cd "$(dirname "$0")" && pwd)"
          cd "$DIR"
          if [ ! -d node_modules ]; then
            echo "[run.sh] Installing dependencies..."
            npm ci --only=production || npm ci
          fi
          export FILE_ROOT="${FILE_ROOT:-$DIR}"
          export PORT="${PORT:-3000}"
            node server/index.js
          EOF
          chmod +x release/run.sh
          tar -C release -czf backpackpi-${VERSION}.tar.gz .
          (cd release && zip -q -r ../backpackpi-${VERSION}.zip .)
          sha256sum backpackpi-${VERSION}.tar.gz backpackpi-${VERSION}.zip > SHA256SUMS
      - name: Verify dist
        if: startsWith(github.ref, 'refs/tags/')
        run: test -d dist || (echo 'dist missing' && exit 1)
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            backpackpi-${{ github.ref_name }}.tar.gz
            backpackpi-${{ github.ref_name }}.zip
            SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
